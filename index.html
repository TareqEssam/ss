
/**
 * ğŸ¤– Ù…Ø­Ù…Ù„ Transformers.js - Ø¯Ø¹Ù… ES Module
 * @version 2.0.0
 */

class TransformersLoader {
  constructor() {
    this.pipeline = null;
    this.isLoaded = false;
    this.isLoading = false;
    this.loadError = null;
    this.useESModule = false;
  }

  /**
   * ğŸš€ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Transformers.js
   */
  async load() {
    if (this.isLoaded) {
      return { success: true, model: this.pipeline };
    }

    if (this.isLoading) {
      console.log('â³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (this.isLoaded) {
            clearInterval(checkInterval);
            resolve({ success: true, model: this.pipeline });
          } else if (this.loadError) {
            clearInterval(checkInterval);
            resolve({ success: false, error: this.loadError });
          }
        }, 500);
      });
    }

    this.isLoading = true;

    try {
      console.log('ğŸ“¦ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªØ¬Ù‡Ø§Øª...');

      // Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ø§Ø³ØªØ®Ø¯Ø§Ù… window.transformers Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ù…Ù„Ø§Ù‹
      if (window.transformers && window.transformers.pipeline) {
        console.log('âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Transformers.js Ù…Ù† window.transformers');
        return await this._loadFromWindow();
      }

      // Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… ES Module Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
      console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ ES Module...');
      return await this._loadAsESModule();

    } catch (error) {
      console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
      this.loadError = error;
      this.isLoading = false;
      
      return { 
        success: false, 
        error: error.message,
        fallback: true 
      };
    }
  }

  /**
   * ğŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† window.transformers
   */
  async _loadFromWindow() {
    try {
      const { pipeline } = window.transformers;
      
      this.pipeline = await pipeline(
        'feature-extraction',
        'Xenova/paraphrase-multilingual-MiniLM-L12-v2',
        {
          quantized: true,
          progress_callback: (progress) => {
            if (progress.status === 'progress') {
              console.log(`â³ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${progress.file} - ${Math.round(progress.progress || 0)}%`);
            }
          }
        }
      );

      this.isLoaded = true;
      this.isLoading = false;
      
      console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªØ¬Ù‡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
      
      return { success: true, model: this.pipeline };

    } catch (error) {
      throw new Error(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† window: ${error.message}`);
    }
  }

  /**
   * ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ ES Module
   */
  async _loadAsESModule() {
    try {
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… import() Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
      const transformersModule = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
      
      const { pipeline } = transformersModule;
      
      this.pipeline = await pipeline(
        'feature-extraction',
        'Xenova/paraphrase-multilingual-MiniLM-L12-v2',
        {
          quantized: true,
          progress_callback: (progress) => {
            if (progress.status === 'progress') {
              console.log(`â³ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${progress.file} - ${Math.round(progress.progress || 0)}%`);
            }
          }
        }
      );

      this.isLoaded = true;
      this.isLoading = false;
      this.useESModule = true;
      
      console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªØ¬Ù‡Ø§Øª ÙƒÙ€ ES Module!');
      
      return { success: true, model: this.pipeline };

    } catch (error) {
      throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ES Module: ${error.message}`);
    }
  }

  /**
   * ğŸ”¢ ØªÙˆÙ„ÙŠØ¯ Ù…ØªØ¬Ù‡ Ù…Ù† Ù†Øµ
   */
  async generateEmbedding(text) {
    if (!this.isLoaded) {
      const loadResult = await this.load();
      if (!loadResult.success) {
        throw new Error('Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…Ø­Ù…Ù„');
      }
    }

    try {
      const output = await this.pipeline(text, {
        pooling: 'mean',
        normalize: true
      });

      const embedding = Array.from(output.data);
      return embedding;

    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ØªØ¬Ù‡:', error);
      throw error;
    }
  }

  /**
   * ğŸ“Š Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
   */
  getStatus() {
    return {
      isLoaded: this.isLoaded,
      isLoading: this.isLoading,
      hasError: !!this.loadError,
      error: this.loadError?.message,
      useESModule: this.useESModule
    };
  }
}

// Export for ES Module
if (typeof window !== 'undefined') {
  window.TransformersLoader = TransformersLoader;
}

export default TransformersLoader;
