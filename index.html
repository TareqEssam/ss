
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ูุณุงุนุฏ ุงููุฌุงู ุงูุฐูู - GAFI AI Assistant</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/ai-assistant.css">
  
  <style>
    /* ... ููุณ ุงูู CSS ุงูุณุงุจู ... */
  </style>
</head>
<body>

  <!-- ุดุงุดุฉ ุงูุชุญููู -->
  <div id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">ุฌุงุฑู ุชุญููู ุงููุณุงุนุฏ ุงูุฐูู...</div>
  </div>

  <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
  <div class="main-content">
    <div class="header">
      <h1>๐ค ูุณุงุนุฏ ุงููุฌุงู ุงูุฐูู</h1>
      <p>ูุณุชุดุงุฑ ุฎุจูุฑ ููููุฆุฉ ุงูุนุงูุฉ ููุงุณุชุซูุงุฑ ูุงูููุงุทู ุงูุญุฑุฉ</p>
    </div>
  </div>

  <!-- ุชุญููู ุงูุชุทุจูู ูู ES Module -->
  <script type="module">
    // ============ ุฌุฒุก 1: ุชุญููู ููุชุจุฉ Transformers.js ูู ES Module ============
    console.log('๐ฆ ุชุญููู ููุชุจุฉ Transformers.js ูู ES Module...');
    
    // ุงุณุชูุฑุงุฏ ุงูููุชุจุฉ ุจุดูู ุตุญูุญ ูู ES Module
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
    
    // ุชููุฆุฉ ุงูุจูุฆุฉ
    env.allowLocalModels = false;
    
    // ุญูุธ ูู window ูููุตูู ูู ุงูุณูุฑูุจุชุงุช ุงููุฏููุฉ
    window.transformers = { pipeline, env };
    window.transformersLoaded = true;
    
    console.log('โ ุชู ุชุญููู Transformers.js ูู ES Module');
    console.log('   - pipeline:', typeof pipeline);
    console.log('   - env:', env);

    // ============ ุฌุฒุก 2: ุชุญููู ุงูููููุงุช ุงูุญุงููุฉ ุฅูู ES Modules ============
    // ูู ูุญุชุงุฌ ุฅูู ูุฐุง ูุฃููุง ุณูุนุฏู transformers-loader.js

    // ============ ุฌุฒุก 3: ุชุญููู ุงูููููุงุช ุงูุฃุณุงุณูุฉ ูู Modules ============
    const modulesToLoad = [
      './js/arabic-normalizer.js',
      './js/transformers-loader.js',
      './js/vector-engine-v7.js',
      './js/intent-classifier.js',
      './js/indexeddb-manager.js',
      './js/query-parser.js',
      './js/learning-system.js',
      './js/response-generator.js',
      './js/ai-expert-core.js',
      './js/voice-handler.js',
      './js/typewriter-effect.js',
      './js/ui-controller.js'
    ];

    async function loadModule(src) {
      try {
        const module = await import(src);
        // ุฅุฐุง ูุงู ููููุฏูู exports defaultุ ูุญูุธู
        if (module.default) {
          const className = module.default.name || src.split('/').pop().replace('.js', '');
          window[className] = module.default;
        }
        return module;
      } catch (error) {
        console.error(`โ ูุดู ุชุญููู ${src}:`, error);
        throw error;
      }
    }

    async function initializeApplication() {
      try {
        console.log('๐ ุจุฏุก ุชุญููู ูุธุงู ุงููุณุงุนุฏ ุงูุฐูู...');

        // === ุงููุฑุญูุฉ 1: ุชุญููู ููุงุนุฏ ุงูุจูุงูุงุช ===
        console.log('๐ฆ ุชุญููู ููุงุนุฏ ุงูุจูุงูุงุช...');
        
        const [activityVectors, decision104Vectors, industrialVectors] = await Promise.all([
          import('./data/activity_vectors.js'),
          import('./data/decision104_vectors.js'),
          import('./data/industrial_vectors.js')
        ]);

        window.activityVectors = activityVectors.default;
        window.decision104Vectors = decision104Vectors.default;
        window.industrialVectors = industrialVectors.default;

        console.log('โ ุชู ุชุญููู ููุงุนุฏ ุงูุจูุงูุงุช');

        // === ุงููุฑุญูุฉ 2: ุชุญููู ุงูููููุงุช ===
        console.log('๐ง ุชุญููู ุงูููููุงุช ุงูุฃุณุงุณูุฉ...');
        
        // ุชุญููู ุฌููุน ุงูููููุงุช
        for (const moduleSrc of modulesToLoad) {
          await loadModule(moduleSrc);
        }

        // === ุงููุฑุญูุฉ 3: ุฅูุดุงุก ุงููุงุฆูุงุช ===
        console.log('๐จ ุฅูุดุงุก ูุงุฆูุงุช ุงูููููุงุช...');
        
        const normalizer = new ArabicNormalizer();
        
        // ุงุณุชุฎุฏุงู VectorEngineV7
        const vectorEngine = new VectorEngineV7(normalizer);
        
        // ูุญุงููุฉ ุชุญููู ุงููููุฐุฌ
        try {
          await vectorEngine.initialize();
        } catch (modelError) {
          console.warn('โ๏ธ ูุดู ุชุญููู ูููุฐุฌ ุงููุชุฌูุงุช:', modelError.message);
          console.log('๐ ุงุณุชุฎุฏุงู ูุถุน Fallback ููุจุญุซ ุงููุตู ููุท');
        }
        
        const intentClassifier = new IntentClassifier(normalizer, vectorEngine);
        const dbManager = new IndexedDBManager();
        const learningSystem = new LearningSystem(dbManager, normalizer);
        const queryParser = new QueryParser(normalizer, intentClassifier);
        const responseGenerator = new ResponseGenerator();
        const voiceHandler = new VoiceHandler();
        const typewriter = new TypewriterEffect();
        
        console.log('โ ุชู ุฅูุดุงุก ุฌููุน ุงูููููุงุช');

        // === ุงููุฑุญูุฉ 4: ุชููุฆุฉ ุงูููุงุฉ ุงูุฑุฆูุณูุฉ ===
        console.log('๐ง ุชููุฆุฉ ุงูููุงุฉ ุงูุฑุฆูุณูุฉ...');
        
        const aiCore = new AIExpertCore();
        aiCore.normalizer = normalizer;
        aiCore.vectorEngine = vectorEngine;
        aiCore.intentClassifier = intentClassifier;
        aiCore.dbManager = dbManager;
        aiCore.learningSystem = learningSystem;
        aiCore.queryParser = queryParser;
        
        aiCore.vectorDatabases = {
          activity: window.activityVectors,
          decision104: window.decision104Vectors,
          industrial: window.industrialVectors
        };
        
        await aiCore.initialize();
        console.log('โ ุงูููุงุฉ ุงูุฑุฆูุณูุฉ ุฌุงูุฒุฉ');

        // === ุงููุฑุญูุฉ 5: ุชููุฆุฉ ุงููุงุฌูุฉ ===
        console.log('๐จ ุชููุฆุฉ ูุงุฌูุฉ ุงููุณุชุฎุฏู...');
        
        const uiController = new UIController(
          aiCore,
          voiceHandler,
          typewriter,
          responseGenerator
        );
        
        await uiController.initialize();
        console.log('โ ุงููุงุฌูุฉ ุฌุงูุฒุฉ');

        // === ุญูุธ ูู window ===
        window.aiAssistant = {
          core: aiCore,
          ui: uiController,
          voice: voiceHandler,
          typewriter: typewriter,
          vectorEngine: vectorEngine,
          transformers: window.transformers,
          stats: () => {
            console.log('๐ ุฅุญุตุงุฆูุงุช ุงููุธุงู:');
            console.log('   - ุฅุญุตุงุฆูุงุช AI:', aiCore.getStatistics());
            console.log('   - ุฅุญุตุงุฆูุงุช ุงููุชุฌูุงุช:', vectorEngine.getStatistics());
            console.log('   - ุฅุญุตุงุฆูุงุช ุงูุชุนูู:', learningSystem.getStatistics());
            console.log('   - Transformers ูุญููุฉ:', !!window.transformers?.pipeline);
          }
        };

        // ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
        document.getElementById('loading-screen').style.display = 'none';

        console.log('');
        console.log('๐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
        console.log('โ ุงููุณุงุนุฏ ุงูุฐูู ุฌุงูุฒ ููุนูู!');
        console.log('๐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
        console.log('');

      } catch (error) {
        console.error('โ ูุดู ุชุญููู ุงููุธุงู:', error);
        document.getElementById('loading-screen').innerHTML = `
          <div style="color: white; text-align: center;">
            <h2 style="color: #ef4444; margin-bottom: 20px;">โ ุฎุทุฃ ูู ุงูุชุญููู</h2>
            <p style="margin-bottom: 20px;">${error.message}</p>
            <button onclick="location.reload()" 
                    style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
              ๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
            </button>
          </div>
        `;
      }
    }

    // ุจุฏุก ุงูุชุทุจูู
    initializeApplication();
  </script>
</body>
</html>
